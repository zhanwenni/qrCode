<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äºŒç»´ç æ‰«æå·¥å…·</title>
    <!--<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/dist/html5-qrcode.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.2.1/html5-qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            text-align: center;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 30px;
            color: #4285f4;
        }
        #scanBtn {
            display: inline-block;
            padding: 15px 30px;
            font-size: 18px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        #scanBtn:hover {
            background-color: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }
        #scanBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
            display: none;
        }
        #loading {
            display: none;
            font-size: 16px;
            color: #666;
            margin: 20px 0;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            background-color: #f0f0f0;
            display: none;
        }
        #result {
            margin-top: 30px;
            padding: 15px;
            border-radius: 8px;
            background-color: #e8f0fe;
            display: none;
        }
        .instructions {
            margin-top: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            text-align: left;
        }
        .instructions h3 {
            color: #4285f4;
            margin-bottom: 10px;
        }
        .instructions ol {
            padding-left: 20px;
        }
        .instructions li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>äºŒç»´ç æ‰«æå·¥å…·</h1>

    <button id="scanBtn">ğŸ“· å¼€å§‹æ‰«æ</button>
    <p id="loading">æ­£åœ¨åˆå§‹åŒ–æ‘„åƒå¤´...</p>
    <div id="qr-reader"></div>

    <div id="status">çŠ¶æ€: <span id="statusText">å‡†å¤‡å°±ç»ª</span></div>
    <div id="result">
        <strong>æ‰«æç»“æœ:</strong> <span id="resultText"></span>
    </div>

    <div class="instructions">
        <h3>ä½¿ç”¨è¯´æ˜:</h3>
        <ol>
            <li>ç‚¹å‡»"å¼€å§‹æ‰«æ"æŒ‰é’®</li>
            <li>å…è®¸æµè§ˆå™¨è®¿é—®æ‘„åƒå¤´</li>
            <li>å°†äºŒç»´ç ç½®äºæ‰«ææ¡†å†…</li>
            <li>ä¿æŒæ‰‹æœºç¨³å®šç›´åˆ°è¯†åˆ«æˆåŠŸ</li>
        </ol>
    </div>
</div>

<script>
    // å…¨å±€å˜é‡
    let html5QrcodeScanner = null;
    let isScanning = false;
    const scanBtn = document.getElementById("scanBtn");
    const loading = document.getElementById("loading");
    const qrReader = document.getElementById("qr-reader");
    const statusText = document.getElementById("statusText");
    const resultDiv = document.getElementById("result");
    const resultText = document.getElementById("resultText");

    // åˆå§‹åŒ–å‡½æ•°
    function initScanner() {
        // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½æˆåŠŸ
        if (typeof Html5Qrcode === "undefined") {
            updateStatus("é”™è¯¯: äºŒç»´ç åº“åŠ è½½å¤±è´¥", "error");
            scanBtn.disabled = true;
            return;
        }

        updateStatus("å‡†å¤‡å°±ç»ª");
        scanBtn.disabled = false;
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(text, type = "info") {
        const statusDiv = document.getElementById("status");
        statusDiv.style.display = "block";
        statusText.textContent = text;

        // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
        statusDiv.style.backgroundColor =
            type === "error" ? "#ffebee" :
                type === "success" ? "#e8f5e9" : "#f0f0f0";
        statusText.style.color =
            type === "error" ? "#f44336" :
                type === "success" ? "#4caf50" : "#333";
    }

    // æ˜¾ç¤ºæ‰«æç»“æœ
    function showResult(text) {
        resultDiv.style.display = "block";
        resultText.textContent = text;
    }

    // å¼€å§‹æ‰«æ
    async function startScan() {
        if (isScanning) return;

        try {
            isScanning = true;
            scanBtn.disabled = true;
            loading.style.display = "block";
            updateStatus("æ­£åœ¨åˆå§‹åŒ–æ‘„åƒå¤´...");

            // åˆ›å»ºæ‰«æå™¨å®ä¾‹
            html5QrcodeScanner = new Html5Qrcode("qr-reader");

            // é…ç½®é€‰é¡¹
            const config = {
                fps: 15, // å¸§ç‡
                qrbox: { width: 250, height: 250 }, // æ‰«ææ¡†å¤§å°
                aspectRatio: 1.0, // å®½é«˜æ¯”
                disableFlip: false, // å…è®¸å›¾åƒç¿»è½¬
                focusMode: "continuous", // æŒç»­å¯¹ç„¦
                exposureMode: "continuous" // æŒç»­æ›å…‰
            };

            // å¯åŠ¨æ‰«æ
            await html5QrcodeScanner.start(
                { facingMode: "environment" }, // ä½¿ç”¨åç½®æ‘„åƒå¤´
                config,
                (decodedText, decodedResult) => {
                    handleScanSuccess(decodedText, decodedResult);
                },
                (errorMessage, error) => {
                    handleScanError(errorMessage, error);
                }
            );

            loading.style.display = "none";
            qrReader.style.display = "block";
            updateStatus("æ­£åœ¨æ‰«æ...", "info");

        } catch (error) {
            handleInitError(error);
        }
    }

    // å¤„ç†æ‰«ææˆåŠŸ
    function handleScanSuccess(decodedText, decodedResult) {
        console.log("æ‰«ææˆåŠŸ:", decodedText, decodedResult);
        updateStatus("æ‰«ææˆåŠŸ!", "success");
        showResult(decodedText);

        // åœæ­¢æ‰«æ
        stopScan();

        // å¤„ç†æ‰«æç»“æœ
        processScannedData(decodedText);
    }

    // å¤„ç†æ‰«æé”™è¯¯
    function handleScanError(errorMessage, error) {
        console.warn(`æ‰«æé”™è¯¯: ${errorMessage}`, error);

        // å¿½ç•¥"æœªæ‰¾åˆ°äºŒç»´ç "çš„å¸¸è§„é”™è¯¯
        if (!errorMessage.includes("No QR code found")) {
            updateStatus(`æ‰«æé”™è¯¯: ${errorMessage}`, "error");
        }
    }

    // å¤„ç†åˆå§‹åŒ–é”™è¯¯
    function handleInitError(error) {
        console.error("åˆå§‹åŒ–é”™è¯¯:", error);
        isScanning = false;
        scanBtn.disabled = false;
        loading.style.display = "none";

        let errorMessage = "æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥";
        if (error.message.includes("Permission denied")) {
            errorMessage = "æ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼Œè¯·å…è®¸è®¿é—®";
        } else if (error.message.includes("No camera found")) {
            errorMessage = "æœªæ‰¾åˆ°å¯ç”¨æ‘„åƒå¤´";
        }

        updateStatus(errorMessage, "error");
        alert(errorMessage);
    }

    // åœæ­¢æ‰«æ
    async function stopScan() {
        if (html5QrcodeScanner && isScanning) {
            try {
                await html5QrcodeScanner.stop();
                html5QrcodeScanner.clear();
                console.log("æ‰«æå·²åœæ­¢");
            } catch (error) {
                console.error("åœæ­¢æ‰«ææ—¶å‡ºé”™:", error);
            } finally {
                resetUI();
            }
        }
    }

    // é‡ç½®UI
    function resetUI() {
        isScanning = false;
        scanBtn.disabled = false;
        qrReader.style.display = "none";
        loading.style.display = "none";
    }

    // å¤„ç†æ‰«æåˆ°çš„æ•°æ®
    function processScannedData(data) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯URL
        if (isValidUrl(data)) {
            updateStatus("æ£€æµ‹åˆ°URLï¼Œå³å°†è·³è½¬...", "success");
            setTimeout(() => {
                window.location.href = data;
            }, 1500);
            return;
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯è®¾å¤‡IDï¼ˆæ ¹æ®æ‚¨çš„éœ€æ±‚è‡ªå®šä¹‰ï¼‰
        if (/^[a-zA-Z0-9_-]{4,}$/.test(data)) {
            updateStatus("æ£€æµ‹åˆ°è®¾å¤‡ID", "success");
            const targetUrl = `http://172.16.0.197:8086/NaNaWeb/CustomOpenWin/shebdj.html?device_id=${encodeURIComponent(data)}`;
            setTimeout(() => {
                window.location.href = targetUrl;
            }, 1500);
            return;
        }

        // å…¶ä»–å†…å®¹
        updateStatus("æ‰«æå®Œæˆ", "success");
        alert(`æ‰«æç»“æœ: ${data}`);
    }

    // éªŒè¯URL
    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }

    // äº‹ä»¶ç›‘å¬
    scanBtn.addEventListener("click", startScan);

    // é¡µé¢åŠ è½½
    window.addEventListener("load", initScanner);
</script>
</body>
</html>
